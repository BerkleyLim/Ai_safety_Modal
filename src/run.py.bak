# src/monitoring/__init__.py

from ultralytics import YOLO
import torch
from typing import List
# ---  Pydantic ìŠ¤í‚¤ë§ˆ ë° íƒ€ì… íŒíŠ¸ ì„í¬íŠ¸ ---
from schemas.monitoring_output import MonitoringOutput, DetectedObject

# --- (ìˆ˜ì • 3 - í–¥í›„) ì´ ê²½ë¡œëŠ” ë¯¸ì„¸ì¡°ì •ëœ ëª¨ë¸ë¡œ ë³€ê²½ë  ê²ƒì…ë‹ˆë‹¤ ---
# (ì˜ˆì‹œ) model = YOLO('runs/train/exp/weights/best.pt')
# í˜„ì¬ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ê¸°ë³¸ ëª¨ë¸ì„ ìœ ì§€í•©ë‹ˆë‹¤.
model = YOLO('yolov8n.pt')

# GPU ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³  ëª¨ë¸ì„ í•´ë‹¹ ì¥ì¹˜ë¡œ ë³´ëƒ…ë‹ˆë‹¤.
device = 'cuda' if torch.cuda.is_available() else 'cpu'
model.to(device)
print(f"ğŸ¤– [Monitoring] YOLOv8 ëª¨ë¸ì„ '{device}' ì¥ì¹˜ì—ì„œ ì‹¤í–‰í•©ë‹ˆë‹¤.")

# --- (ìˆ˜ì • 2 - í–¥í›„) ë¯¸ì„¸ì¡°ì • í›„ ì‹¤ì œ ìœ„í—˜ í´ë˜ìŠ¤ë¡œ ë³€ê²½ë  ëª©ë¡ ---
# (ì˜ˆì‹œ) TARGET_HAZARDS = ['UA-01', 'UA-17', 'UC-20']
# í˜„ì¬ëŠ” 'person'ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
CURRENT_TEST_TARGET = 'potted plant'


def detect_objects(image_path: str) -> MonitoringOutput:
    """
    [ì‹¤ì œ Monitoring Layer í•¨ìˆ˜]
    YOLOv8 ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ì—ì„œ ê°ì²´ë¥¼ íƒì§€í•˜ê³ ,
    ë¯¸ë¦¬ ì •ì˜ëœ ê·œì¹™ì— ë”°ë¼ 'ì´ìƒ ìƒí™©' ì—¬ë¶€ë¥¼ íŒë‹¨í•©ë‹ˆë‹¤.

    Args:
        image_path (str): ë¶„ì„í•  ì´ë¯¸ì§€ íŒŒì¼ì˜ ê²½ë¡œ

    Returns:
        MonitoringOutput: Pydantic ìŠ¤í‚¤ë§ˆì— ì •ì˜ëœ íƒì§€ ê²°ê³¼ ê°ì²´
    """
    print(f"ğŸ‘€ [Monitoring] YOLOv8 ëª¨ë¸ë¡œ '{image_path}'ì˜ ê°ì²´ íƒì§€ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...")

    # 2. ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ ì¶”ë¡  ì‹¤í–‰
    results = model(image_path)

    detected_objects_list_raw = [] # ë”•ì…”ë„ˆë¦¬ë¥¼ ì„ì‹œ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸

    # 3. íƒì§€ ê²°ê³¼ì—ì„œ í•„ìš”í•œ ì •ë³´ ì¶”ì¶œ
    for result in results:
        boxes = result.boxes

        for i in range(len(boxes)):
            class_id = int(boxes.cls[i])
            class_name = model.names[class_id]
            confidence = float(boxes.conf[i])
            box = boxes.xyxy[i].cpu().numpy().tolist()

            # Pydanticì˜ alias='class'ì— ë§ê²Œ ë”•ì…”ë„ˆë¦¬ ìƒì„±
            detected_objects_list_raw.append({
                "class": class_name,
                "confidence": confidence,
                "box": box
            })

    # --- ë”•ì…”ë„ˆë¦¬ ë¦¬ìŠ¤íŠ¸ë¥¼ Pydantic ëª¨ë¸ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜ ---
    pydantic_detected_objects: List[DetectedObject] = []
    for obj_dict in detected_objects_list_raw:
        try:
            # Pydantic ëª¨ë¸ë¡œ ë³€í™˜ (ìë™ ìœ íš¨ì„± ê²€ì‚¬)
            pydantic_detected_objects.append(DetectedObject(**obj_dict))
        except Exception as e:
            print(f"ğŸš¨ [Monitoring] Pydantic DetectedObject ë³€í™˜ ì˜¤ë¥˜: {e} - ë°ì´í„°: {obj_dict}")


    # 4. ì´ìƒ ìƒí™© íŒë‹¨ ë¡œì§ (ì—°êµ¬ì˜ í•µì‹¬ ë¶€ë¶„)
    # --- ë¯¸ì„¸ì¡°ì • í›„ ì´ ë¡œì§ì€ TARGET_HAZARDS ëª©ë¡ì„ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½ë˜ì–´ì•¼ í•©ë‹ˆë‹¤ ---
    detected_class_names = [obj.class_name for obj in pydantic_detected_objects]
    print("detected_class_name", detected_class_names)

    # (í˜„ì¬ í…ŒìŠ¤íŠ¸ ë¡œì§)
    if CURRENT_TEST_TARGET in detected_class_names:
        status = "anomaly_detected"
        print(f"âœ… [Monitoring] '{CURRENT_TEST_TARGET}' ê°ì²´ íƒì§€! ì´ìƒ ìƒí™©ìœ¼ë¡œ íŒë‹¨í•©ë‹ˆë‹¤.")
    else:
        status = "normal"
        print("â¡ï¸ [Monitoring] íŠ¹ì´ì‚¬í•­ ì—†ìŒ. íŒŒì´í”„ë¼ì¸ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")

    # (ë¯¸ì„¸ì¡°ì • í›„ ë¡œì§ ì˜ˆì‹œ)
    # is_anomaly = any(cls in TARGET_HAZARDS for cls in detected_class_names)
    # status = "anomaly_detected" if is_anomaly else "normal"
    # if is_anomaly:
    #     print("âœ… [Monitoring] ìœ„í—˜ ì´ë²¤íŠ¸ ê°ì§€! ì´ìƒ ìƒí™©ìœ¼ë¡œ íŒë‹¨í•©ë‹ˆë‹¤.")
    # else:
    #     print("â¡ï¸ [Monitoring] íŠ¹ì´ì‚¬í•­ ì—†ìŒ. íŒŒì´í”„ë¼ì¸ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
    # ---------------------------------------------------

    try:
        output = MonitoringOutput(
            status=status,
            image_path=image_path,
            detected_objects=pydantic_detected_objects
        )
        return output
    except Exception as e:
        print(f"ğŸš¨ [Monitoring] Pydantic MonitoringOutput ë³€í™˜ ì˜¤ë¥˜: {e}")
        # ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ìŠ¤í‚¤ë§ˆì— ë§ëŠ” ê°ì²´ ë°˜í™˜ (ì˜¤ë¥˜ ìƒíƒœ ëª…ì‹œ)
        return MonitoringOutput(status="error_parsing_output", image_path=image_path, detected_objects=[])