# 모델 아키텍처 설계

물류창고 안전 관제 시스템의 전체 아키텍처 및 각 레이어별 설계 문서

## 시스템 개요

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        물류창고 안전 관제 시스템                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   [CCTV 영상/이미지]                                                     │
│          │                                                              │
│          ▼                                                              │
│   ┌─────────────────┐                                                   │
│   │  1. Monitoring  │  YOLO 객체 탐지                                    │
│   │    (YOLOv8)     │  → 위험 객체/행동 탐지                              │
│   └────────┬────────┘                                                   │
│            │ MonitoringOutput                                           │
│            ▼                                                            │
│   ┌─────────────────┐                                                   │
│   │  2. Reasoning   │  VLM 위험 분석                                     │
│   │   (GPT-4V)      │  → 맥락 기반 위험도 판단                            │
│   └────────┬────────┘                                                   │
│            │ ReasoningOutput                                            │
│            ▼                                                            │
│   ┌─────────────────┐                                                   │
│   │   3. Action     │  LLM 가이드라인 생성                                │
│   │   (GPT-4)       │  → 다국어 안전 지침 생성                            │
│   └────────┬────────┘                                                   │
│            │ ActionOutput                                               │
│            ▼                                                            │
│   [안전 가이드라인 / 알림]                                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 1. Monitoring Layer (객체 탐지)

### 역할
- CCTV 영상/이미지에서 안전 관련 객체 및 위험 행동 탐지
- 실시간 객체 감지 및 분류

### 모델
- **YOLOv8** (Ultralytics)
- 카테고리별 개별 모델 학습 (11개)
- 커스텀 모델 없으면 기본 `yolov8n.pt` 사용

### 모델 로딩 전략
```
models/ 폴더에서 best.pt 검색
    │
    ├─ 있음 → 커스텀 모델 로드 → ANOMALY_CLASSES 기준 이상 판단
    │
    └─ 없음 → yolov8n.pt 로드 → 'person' 탐지 시 이상 판단
```

### 입력
- 이미지 (jpg, png)

### 출력 스키마 (MonitoringOutput)
```python
{
    "status": "anomaly_detected" | "normal",
    "image_path": "경로",
    "detected_objects": [
        {
            "class": "클래스명",
            "confidence": 0.95,
            "box": [x_min, y_min, x_max, y_max]
        }
    ]
}
```

### 탐지 클래스 (57개)
| 유형 | 개수 | 예시 |
|------|------|------|
| 정적 객체 (SO) | 21 | 보관랙, 도크, 소화기, 안전펜스 |
| 동적 객체 (WO) | 8 | 작업자, 지게차, 화물트럭 |
| 위험 행동 (UA) | 13 | 지게차 시야미확보, 화물 붕괴 |
| 위험 상태 (UC) | 15 | 지게차 통로 미표시, 파렛트 파손 |

### 카테고리별 모델
| 번호 | 카테고리 |
|------|----------|
| 01 | 도크설비 |
| 02 | 보관 |
| 03 | 부가가치서비스 |
| 04 | 설비및장비 |
| 05 | 운반 |
| 06 | 입고 |
| 07 | 지게차 |
| 08 | 출고 |
| 09 | 파렛트렉 |
| 10 | 피킹분배 |
| 11 | 화재 |

학습 완료 시 모델 저장 경로: `models/safety_{카테고리}_{이름}_{타임스탬프}/weights/best.pt`

---

## 2. Reasoning Layer (위험 분석)

### 역할
- 탐지된 객체의 맥락을 분석하여 실제 위험도 판단
- 이미지 + 탐지 결과를 종합하여 위험 이유 도출

### 모델
- **GPT-4V (Vision)** 또는 동등 VLM
- 멀티모달 입력 처리

### 입력
- MonitoringOutput (탐지 결과)
- 원본 이미지

### 출력 스키마 (ReasoningOutput)
```python
{
    "risk_level": "LOW" | "MED" | "HIGH",
    "reason": "위험 발생 이유 (한국어)",
    "image_path": "경로"
}
```

### 위험도 기준
| 등급 | 설명 | 예시 |
|------|------|------|
| LOW | 경미한 위험 | 안전모 미착용 (단독 작업) |
| MED | 주의 필요 | 통로에 적재물 |
| HIGH | 즉각 대응 필요 | 지게차-작업자 충돌 위험 |

---

## 3. Action Layer (가이드라인 생성)

### 역할
- 위험 분석 결과에 따른 대응 조치 결정
- 다국어 안전 가이드라인 생성

### 모델
- **GPT-4** 또는 동등 LLM

### 입력
- ReasoningOutput (위험 분석 결과)

### 출력 스키마 (ActionOutput)
```python
{
    "status": "logged" | "confirmation_requested" | "multilingual_guideline_generated",
    "risk_level_processed": "LOW" | "MED" | "HIGH",
    "reason_detected": "위험 발생 이유",
    "guidelines": {
        "guideline_ko": "한국어 안전 지침",
        "guideline_en": "영어 안전 지침",
        "guideline_vi": "베트남어 안전 지침"
    }
}
```

### 위험 등급별 대응
| 등급 | 조치 |
|------|------|
| LOW | 로그 기록 |
| MED | 관리자 확인 요청 |
| HIGH | 즉시 경고 + 다국어 가이드라인 생성 |

---

## 데이터 흐름

```
이미지 입력
    │
    ▼
┌─────────────────────────────────────────┐
│ Monitoring (YOLO)                       │
│ - 객체 탐지                              │
│ - 바운딩 박스 + 신뢰도 반환               │
└─────────────────────────────────────────┘
    │
    │ status == "anomaly_detected" ?
    │
    ▼ Yes
┌─────────────────────────────────────────┐
│ Reasoning (VLM)                         │
│ - 이미지 + 탐지결과 분석                  │
│ - 위험도 판정 (LOW/MED/HIGH)             │
│ - 위험 이유 도출                         │
└─────────────────────────────────────────┘
    │
    │ risk_level ?
    │
    ▼
┌─────────────────────────────────────────┐
│ Action (LLM)                            │
│ - LOW: 로그 기록                         │
│ - MED: 관리자 확인 요청                   │
│ - HIGH: 다국어 가이드라인 생성            │
└─────────────────────────────────────────┘
    │
    ▼
출력 (알림/가이드라인)
```

---

## 기술 스택

| 구성 요소 | 기술 |
|-----------|------|
| 객체 탐지 | YOLOv8 (Ultralytics) |
| VLM | GPT-4V (OpenAI) |
| LLM | GPT-4 (OpenAI) |
| 데이터 검증 | Pydantic |
| 학습 데이터 | AI Hub 물류센터 안전 데이터 |
| 프레임워크 | Python 3.10+ |

---

## 4. Evaluation Layer (평가 및 검증)

### 역할
- YOLO 모델 성능 지표 추출 및 분석
- 프레임워크 적합성 검증
- 학습 결과 시각화

### 모듈 구성
```
src/evaluation/
├── metrics.py         # 성능 지표 추출
├── validation.py      # 적합성 검증
├── visualize.py       # 시각화
└── generate_report.py # 통합 리포트 CLI
```

### 성능 지표 (`metrics.py`)
| 지표 | 설명 |
|------|------|
| mAP50 | IoU 0.5 기준 평균 정밀도 |
| mAP50-95 | IoU 0.5~0.95 기준 평균 정밀도 |
| Precision | 정밀도 |
| Recall | 재현율 |

### 적합성 검증 항목 (`validation.py`)
1. YOLO 모델 파일 존재 여부
2. YOLO 모델 성능 기준 (mAP50 >= 0.5)
3. 이상 탐지 클래스 정의 (ANOMALY_CLASSES)
4. 3-Layer 파이프라인 구조
5. Pydantic 스키마 정의
6. YOLO 추론 속도 (1초 이내)

### 시각화 (`visualize.py`)
- 학습 손실 곡선 (Box Loss, Cls Loss)
- 성능 지표 변화 (mAP, Precision, Recall)
- 종합 대시보드 (`training_dashboard.png`)